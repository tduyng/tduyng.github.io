{{ if .Page.Config.tags }}
{{ $blog_section := get_section "blog" }}
{{ $currentPermalink := .Page.Permalink }}
{{ $currentTags := .Page.Config.tags }}

<!-- First pass: count matching posts -->
{{ $foundCount := 0 }}
{{ range (reverse $blog_section.Children) }}
    {{ if and (ne .Permalink $currentPermalink) (lt $foundCount 3) }}
        {{ if .Config.tags }}
            {{ $hasMatch := false }}
            {{ range .Config.tags }}
                {{ $postTag := . }}
                {{ range $currentTags }}
                    {{ if eq . $postTag }}
                        {{ $hasMatch = true }}
                    {{ end }}
                {{ end }}
            {{ end }}
            {{ if $hasMatch }}
                {{ $foundCount = add $foundCount 1 }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}

<!-- Only show section if we found related posts -->
{{ if gt $foundCount 0 }}
<section id="related-posts">
    <h3>Related Posts</h3>
    <div class="related-posts-grid">
        {{ $rendered := 0 }}
        {{ range (reverse $blog_section.Children) }}
            {{ if and (ne .Permalink $currentPermalink) (lt $rendered 3) }}
                {{ if .Config.tags }}
                    {{ $hasMatch := false }}
                    {{ range .Config.tags }}
                        {{ $postTag := . }}
                        {{ range $currentTags }}
                            {{ if eq . $postTag }}
                                {{ $hasMatch = true }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                    {{ if $hasMatch }}
                        {{ $rendered = add $rendered 1 }}
                        {{ $post_image := "/img/post-cover.webp" }}
                        {{ if .Config.extra.img }}
                            {{ $img_path := .Config.extra.img }}
                            {{ $first_char := index (split $img_path "") 0 }}
                            {{ if eq $first_char "/" }}
                                {{ $post_image = $img_path }}
                            {{ else }}
                                {{ $post_image = printf "%s%s" .Permalink $img_path }}
                            {{ end }}
                        {{ end }}
                        
                        <article class="related-post-card">
                            <a class="instant" href="{{ .Permalink }}">
                                <div class="post-card-image">
                                    <img src="{{ $post_image }}" alt="{{ .Config.title }}" width="1200" height="630" loading="lazy" decoding="async" onerror="this.src='/img/post-cover.webp'" />
                                </div>
                                <h4>{{ .Config.title }}</h4>
                                {{ if .Config.description }}
                                <p class="description">{{ .Config.description }}</p>
                                {{ end }}
                                <div class="related-tags">
                                    {{ range .Config.tags }}
                                        <span class="tag">#{{ . }}</span>
                                    {{ end }}
                                </div>
                                <span class="read-more">Read more â†’</span>
                            </a>
                        </article>
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}
    </div>
</section>
{{ end }}
{{ end }}
