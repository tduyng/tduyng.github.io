{{ if .Page.Config.tags }}
{{ $blog_section := get_section "blog" }}
{{ $currentPermalink := .Page.Permalink }}
{{ $currentTags := .Page.Config.tags }}

<!-- First pass: count matching posts -->
{{ $foundCount := 0 }}
{{ range $blog_section.Children }}
    {{ if and (ne .Permalink $currentPermalink) (lt $foundCount 4) }}
        {{ if .Config.tags }}
            {{ $hasMatch := false }}
            {{ range .Config.tags }}
                {{ $postTag := . }}
                {{ range $currentTags }}
                    {{ if eq . $postTag }}
                        {{ $hasMatch = true }}
                    {{ end }}
                {{ end }}
            {{ end }}
            {{ if $hasMatch }}
                {{ $foundCount = add $foundCount 1 }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}

<!-- Only show section if we found related posts -->
{{ if gt $foundCount 0 }}
<section id="related-posts">
    <h3>Related Posts</h3>
    <div class="related-posts-grid">
        {{ $rendered := 0 }}
        {{ range $blog_section.Children }}
            {{ if and (ne .Permalink $currentPermalink) (lt $rendered 4) }}
                {{ if .Config.tags }}
                    {{ $hasMatch := false }}
                    {{ range .Config.tags }}
                        {{ $postTag := . }}
                        {{ range $currentTags }}
                            {{ if eq . $postTag }}
                                {{ $hasMatch = true }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                    {{ if $hasMatch }}
                        {{ $rendered = add $rendered 1 }}
                        <article class="related-post-card">
                            <a class="instant" href="{{ .Permalink }}">
                                <h4>{{ .Config.title }}</h4>
                                {{ if .Config.description }}
                                <p class="description">{{ .Config.description }}</p>
                                {{ end }}
                                <div class="related-tags">
                                    {{ range .Config.tags }}
                                        <span class="tag">#{{ . }}</span>
                                    {{ end }}
                                </div>
                                <span class="read-more">Read more â†’</span>
                            </a>
                        </article>
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}
    </div>
</section>
{{ end }}
{{ end }}
