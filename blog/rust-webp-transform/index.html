<!doctype html>

<html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta name="color-scheme" content="dark" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="base" content="https://tduyng.com" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="robots" content="index, nofollow" />
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
    <link rel="canonical" href="https://tduyng.com/blog/rust-webp-transform" />
    
    <meta name="keywords" content="performance, rust, webp, image-conversion, cli" />
    
    <meta name="author" content="Duy NG" />
    <title>Transforming website images into WebP with Rust for faster loading times</title>
    <meta
        property="og:title"
        content="Transforming website images into WebP with Rust for faster loading times"
    />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Duy NG" />
    
    <meta name="description" content="Explore the process of enhancing website speed through image conversion to WebP using Rust" />
    <meta property="og:description" content="Explore the process of enhancing website speed through image conversion to WebP using Rust" />
    
    <meta property="og:image" content="https://tduyng.com/blog/rust-webp-transform/img/page_speed.webp" />
    <meta property="og:image:width" content="1500" />
    <meta property="og:image:height" content="750" />
    <meta name="twitter:image" content="https://tduyng.com/blog/rust-webp-transform/img/page_speed.webp" />
    <meta name="twitter:card" content="summary_large_image" />
    
    <link rel="stylesheet" href="/css/main.css" />
</head>

    <body class="post">
        
<header class="blur">
    <div id="header-wrapper">
        <nav>
            <a class="instant" href="/">tduyng</a>

            
            <button id="toggler" class="separator" aria-label="toggle expand">
                ☰
            </button>
            <span class="wrap left fold">[</span>

               
            <a class="instant " href="/blog">
                blog
            </a>

            
            <span class="wrap-separator fold">,</span>
              
            <a class="instant fold" href="/notes">
                notes
            </a>

            
            <span class="wrap-separator fold">,</span>
              
            <a class="instant fold" href="/about">
                about
            </a>

             

            <span class="wrap right fold">]</span>
            
        </nav>
    </div>
</header>


        <div id="wrapper">
            <div id="blank"></div>
            <aside>
                
<nav>
    <ul>
        
        <li>
            <a class="h2" href="#converting-images-to-webp-with-rust">Converting images to WebP with Rust</a>
            
        </li>
        
        <li>
            <a class="h2" href="#addressing-generated-image-size-issues">Addressing generated image size issues</a>
            
        </li>
        
    </ul>
</nav>


                <button id="back-to-top" aria-label="back to top">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill="currentColor"></path></svg>
                </button>
            </aside>
            <main>
                <div>
                    
<div
    id="copy-cfg"
    style="display: none"
    data-copy-icon="&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; viewBox=&#34;0 0 24 24&#34; width=&#34;20&#34; height=&#34;20&#34;&gt;&lt;path d=&#34;M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&lt;/svg&gt;"
    data-check-icon="&lt;svg xmlns=&#34;http://www.w3.org/2000/svg&#34; viewBox=&#34;0 0 24 24&#34; width=&#34;20&#34; height=&#34;20&#34;&gt;&lt;path d=&#34;M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&lt;/svg&gt;"
></div>

 
                    <article class="prose" data-backlink-icon="">
                        <h1>Transforming website images into WebP with Rust for faster loading times</h1>
                        <div id="post-info">
                            <div id="date">
                                <span id="publish">May 23, 2024</span>
                                
                                <span>Last update:</span>
                                <span id="updated"
                                    >May 23, 2024</span
                                >
                                
                            </div>

                            <div id="wordcount">
    <span>1297 words - 6 min read</span>
</div>

                        </div>

                        <div id="tags">
                              
                            <a class="instant" href="/tags/performance"><span>#</span>performance</a>
                              
                            <a class="instant" href="/tags/rust"><span>#</span>rust</a>
                              
                            <a class="instant" href="/tags/webp"><span>#</span>webp</a>
                              
                            <a class="instant" href="/tags/image-conversion"><span>#</span>image-conversion</a>
                              
                            <a class="instant" href="/tags/cli"><span>#</span>cli</a>
                            
                        </div>

                        
 <p>Hi everyone 👋,</p>
<p>Recently, I attended <a href="https://www.ekino.fr/">Ekinoday</a>, our company’s annual conference, where my colleagues share knowledge on various topics, from technology to life tips. This event is always very interesting for me.</p>
<p>I had a chance to talk with my colleague <a href="https://github.com/thovo">Raphaël Tho Vo</a>, who gave a presentation on optimising web performance. <a href="https://github.com/thovo">Raphaël</a> mentioned that many people don’t realise how much image size and format can effect the web performance. Large image files can slow down a website significantly, affecting user experience.</p>
<p>Raphaël explained that we can improve performance by using better image formats. He mentioned several modern formats like <a href="https://www.smashingmagazine.com/2021/09/modern-image-formats-avif-webp/">AVIF, WebP, JPEG 2000</a>. Among these, AVIF and WebP are the most supported by web browsers today.</p>
<p>Inspired by Raphaël’s advice, I decided to take a closer look at my website's performance. I host my site on GitHub, using <a href="https://www.getzola.org/">Zola</a>, a static site engine, along with the <a href="https://github.com/welpo/tabi">Tabi</a> theme. This theme is beautifully designed and well-coded.</p>
<p>I tested my website with <a href="https://pagespeed.web.dev/">PageSpeed Insights</a> and got a perfect score of 100/100 in everything: Performance, Accessibility, Best Practices, and SEO.</p>
<p><img src="img/page_speed.webp" alt="page speed" loading="lazy"><br/></p>
<p>However, I noticed that I still use a lot of PNG and JPEG images. Switching to WebP could significantly decrease image sizes and improve more load times.</p>
<h3 id="converting-images-to-webp-with-rust">Converting images to WebP with Rust</h3>
<p>How can we accomplish this?</p>
<p>To optimise images, I had to convert them to WebP format. I chose this format because it's effective and widely supported across different web browsers. But I needed a quick way to convert multiple images to WebP and reuse it multiple times.</p>
<p>There are online tools available to help, but that's not the solution I'm looking for at the moment. Instead, I've chosen to create my own solution using Rust. Rust is great for this because it's fast and easy to use for simple programs. Making this program will help me learn more about Rust.</p>
<p>The objectif is to convert all kinds of images into WebP with just one command, making it fast and easy.</p>
<p>Now, let's coding!</p>
<p>For this program, I used the <a href="https://github.com/image-rs/image">image</a> crate for decoding and encoding images. This crate supports many different image formats:</p>
<table>
<thead>
<tr>
<th>Format</th>
<th>Decoding</th>
<th>Encoding</th>
</tr>
</thead>
<tbody>
<tr>
<td>AVIF</td>
<td>Yes (8-bit only) *</td>
<td>Yes (lossy only)</td>
</tr>
<tr>
<td>BMP</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Farbfeld</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>GIF</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>HDR</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>ICO</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>JPEG</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>EXR</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>PNG</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>PNM</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>QOI</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>TGA</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>TIFF</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>WebP</td>
<td>Yes</td>
<td>Yes (lossless only)</td>
</tr>
</tbody>
</table>
<p>**To encode an image to WebP, I created a function <code>encode_webp</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#ff79c6">use</span> image::{DynamicImage, WebPEncoder, ExtendedColorType};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">pub</span> <span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">encode_webp</span>(image: <span style="color:#ff79c6">&amp;</span><span style="color:#50fa7b">DynamicImage</span>) -&gt; <span style="color:#8be9fd;font-style:italic">Result</span><span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">Vec</span><span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd">u8</span><span style="color:#ff79c6">&gt;</span>, <span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Convert the image to RGBA format
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> rgba_image <span style="color:#ff79c6">=</span> image.to_rgba8();
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#ff79c6">mut</span> webp_data <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">Vec</span>::new();
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create a WebP encoder (support only lossless feature for now)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> encoder <span style="color:#ff79c6">=</span> WebPEncoder::new_lossless(<span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">mut</span> webp_data);
</span></span><span style="display:flex;"><span>    encoder
</span></span><span style="display:flex;"><span>        .encode(
</span></span><span style="display:flex;"><span>            rgba_image.as_raw(),
</span></span><span style="display:flex;"><span>            rgba_image.width(),
</span></span><span style="display:flex;"><span>            rgba_image.height(),
</span></span><span style="display:flex;"><span>            ExtendedColorType::Rgba8, <span style="color:#6272a4">// Image crate support only Rgb8 or Rgba8 data
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        )
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> format!(<span style="color:#f1fa8c">&#34;{e}&#34;</span>))<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">Ok</span>(webp_data)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <code>DynamicImage</code> type from <a href="https://github.com/image-rs/image">image</a> crate allows us to handle different image formats. I convert the image to RGBA format and use the WebPEncoder to encode it.</p>
<p><strong>Next, I wrote a function to convert a single image</strong>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#ff79c6">use</span> image::io::Reader;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> std::{fs, path::Path};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">convert_image</span>(input_path: <span style="color:#ff79c6">&amp;</span><span style="color:#50fa7b">Path</span>, output_dir: <span style="color:#ff79c6">&amp;</span><span style="color:#8be9fd;font-style:italic">Option</span><span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span>) -&gt; <span style="color:#8be9fd;font-style:italic">Result</span><span style="color:#ff79c6">&lt;</span>(), <span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Open and decode the image
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> image_render <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>        Reader::open(input_path).map_err(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> format!(<span style="color:#f1fa8c">&#34;Failed to open image: {}&#34;</span>, e))<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> image <span style="color:#ff79c6">=</span> image_render
</span></span><span style="display:flex;"><span>        .decode()
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> format!(<span style="color:#f1fa8c">&#34;Failed to decode image: {}\n&#34;</span>, e))<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Encode the image to WebP
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> webp_data <span style="color:#ff79c6">=</span> encode_webp(<span style="color:#ff79c6">&amp;</span>image)<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Determine the output path
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> output_path <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">Some</span>(output_dir) <span style="color:#ff79c6">=</span> output_dir {
</span></span><span style="display:flex;"><span>        Path::new(output_dir)
</span></span><span style="display:flex;"><span>            .join(input_path.file_stem().unwrap())
</span></span><span style="display:flex;"><span>            .with_extension(<span style="color:#f1fa8c">&#34;webp&#34;</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        input_path.with_extension(<span style="color:#f1fa8c">&#34;webp&#34;</span>)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Write the WebP image to the output path
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    fs::write(output_path.clone(), webp_data.to_vec())
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> format!(<span style="color:#f1fa8c">&#34;Failed to write WebP file: {}&#34;</span>, e))<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#f1fa8c">&#34;Generated: {}&#34;</span>, output_path.display());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">Ok</span>(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span></code></pre><p>This function first opens and decodes the image, then encodes it to WebP format using the previously defined <code>encode_webp</code> function. Finally, it writes the resulting WebP image to either the specified output directory or the same location as the original image.</p>
<p><strong>To convert all images in a directory, I created a function <code>convert_images</code>:</strong></p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#ff79c6">use</span> image::{io::Reader, DynamicImage};
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> rayon::prelude::<span style="color:#ff79c6">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> std::{
</span></span><span style="display:flex;"><span>    fs,
</span></span><span style="display:flex;"><span>    path::Path,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">convert_images</span>(path: <span style="color:#ff79c6">&amp;</span><span style="color:#50fa7b">Path</span>, output_dir: <span style="color:#ff79c6">&amp;</span><span style="color:#8be9fd;font-style:italic">Option</span><span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span>) -&gt; <span style="color:#8be9fd;font-style:italic">Result</span><span style="color:#ff79c6">&lt;</span>(), <span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> path.is_dir() {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">let</span> entries: <span style="color:#8be9fd;font-style:italic">Vec</span><span style="color:#ff79c6">&lt;</span>PathBuf<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">=</span> fs::read_dir(path)
</span></span><span style="display:flex;"><span>            .map_err(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> format!(<span style="color:#f1fa8c">&#34;Read directory failed: {e}&#34;</span>))<span style="color:#ff79c6">?</span>
</span></span><span style="display:flex;"><span>            .filter_map(<span style="color:#ff79c6">|</span>entry<span style="color:#ff79c6">|</span> entry.ok().map(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> e.path()))
</span></span><span style="display:flex;"><span>            .collect();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        entries.par_iter().try_for_each(<span style="color:#ff79c6">|</span>path<span style="color:#ff79c6">|</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> path.is_dir() {
</span></span><span style="display:flex;"><span>                convert_images(path, output_dir)
</span></span><span style="display:flex;"><span>            } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> is_supported(path) {
</span></span><span style="display:flex;"><span>                convert_image(path, output_dir)
</span></span><span style="display:flex;"><span>            } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">Ok</span>(())
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        })<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">Ok</span>(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">is_supported</span>(path: <span style="color:#ff79c6">&amp;</span><span style="color:#50fa7b">Path</span>) -&gt; <span style="color:#8be9fd">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">match</span> fs::read(path) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">Ok</span>(data) <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> path.extension().unwrap_or_default() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;webp&#34;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            image::guess_format(<span style="color:#ff79c6">&amp;</span>data).is_ok()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">Err</span>(_) <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span></code></pre><p>This function checks if the path is a directory. If it is, it reads all entries and recursively processes each one. If the path is an image, it converts it to WebP. The <code>par_iter()</code> method from the <a href="https://github.com/rayon-rs/rayon">rayon</a> crate enables parallel processing for better performance.</p>
<p>Finally, the <code>main</code> function serves as the entry point of the application:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#ff79c6">use</span> clap::Parser;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> image::{io::Reader, DynamicImage};
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> rayon::prelude::<span style="color:#ff79c6">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> std::{
</span></span><span style="display:flex;"><span>    fs,
</span></span><span style="display:flex;"><span>    path::{Path, PathBuf},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#[derive(Parser, Debug)]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">CliArgs</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">#[clap(short, long)]</span>
</span></span><span style="display:flex;"><span>    dir: <span style="color:#8be9fd;font-style:italic">Option</span><span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">#[clap(short, long)]</span>
</span></span><span style="display:flex;"><span>    output: <span style="color:#8be9fd;font-style:italic">Option</span><span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> args <span style="color:#ff79c6">=</span> CliArgs::parse();
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> dir <span style="color:#ff79c6">=</span> args.dir.unwrap_or_else(<span style="color:#ff79c6">||</span> <span style="color:#f1fa8c">&#34;.&#34;</span>.to_string());
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> output_dir <span style="color:#ff79c6">=</span> args.output;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> path <span style="color:#ff79c6">=</span> Path::new(<span style="color:#ff79c6">&amp;</span>dir);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">Err</span>(e) <span style="color:#ff79c6">=</span> convert_images(path, <span style="color:#ff79c6">&amp;</span>output_dir) {
</span></span><span style="display:flex;"><span>        eprint!(<span style="color:#f1fa8c">&#34;Error {}&#34;</span>, e)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>I use the <a href="https://github.com/clap-rs/clap">clap</a> crate to create the CLI. The program accepts a directory containing images to convert and an optional output directory (see more at convert_image function)</p>
<h3 id="addressing-generated-image-size-issues">Addressing generated image size issues</h3>
<p>While working on converting images to WebP format, I encountered a problem: some of the converted images turned out to be larger in size than the originals. This was concerning because my goal was to reduce image size to improve website performance.</p>
<p>I realized that this happened because the image crate in this moment is only supported a <code>new_lossless</code> feature for WebP conversion. This feature maintains the same quality as the original image, sometimes resulting in larger file sizes.</p>
<p>To address this issue, I explored other options and came across the <a href="https://github.com/jaredforth/webp">webp</a> crate.</p>
<p>This crate, built on the <code>libwebp-sys</code> and <code>image</code> crate, allows us to better encode images to WebP format with <code>quality</code> control.</p>
<p>I found that by setting the <code>quality</code> parameter to the maximum value of <code>100</code>, we could consistently generate WebP images with smaller sizes than the originals. In fact, I could reduce the image size by up to 45%.</p>
<p>To apply the <code>webp</code> crate into my code, I only needed to make a slight modification to the <code>encode_webp</code> function. Here's the updated code snippet:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span><span style="color:#ff79c6">use</span> image::DynamicImage;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">use</span> webp::{Encoder,WebPMemory};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">pub</span> <span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">encode_webp</span>(image: <span style="color:#ff79c6">&amp;</span><span style="color:#50fa7b">DynamicImage</span>) -&gt; <span style="color:#8be9fd;font-style:italic">Result</span><span style="color:#ff79c6">&lt;</span>WebPMemory, <span style="color:#8be9fd;font-style:italic">String</span><span style="color:#ff79c6">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> encoder <span style="color:#ff79c6">=</span> Encoder::from_image(image)
</span></span><span style="display:flex;"><span>        .map_err(<span style="color:#ff79c6">|</span>e<span style="color:#ff79c6">|</span> format!(<span style="color:#f1fa8c">&#34;Failed to create a webp encoder: {}&#34;</span>, e))<span style="color:#ff79c6">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> webp_data <span style="color:#ff79c6">=</span> encoder.encode(<span style="color:#bd93f9">100.0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">Ok</span>(webp_data)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Now, with this program, I can quickly convert all images from my website to WebP format.</p>
<p>Here's an example of a command-line <code>webp</code> in this tool:
<img src="img/webp_cmd.webp" alt="webp cmd" loading="lazy"></p>
<p>You can check out the full code on my GitHub repo: <a href="https://github.com/tduyng/imgc-rs">imgc-rs</a>.</p>
<p>I think this project has a lot of potential. We can add a lot more features like batch processing, additional image format conversions, and more. All suggestions and contributions are welcome to make it even better.</p>
<p>Thank you for reading so far! I hope you found this article helpful and gained some new ideas. If you have any questions or suggestions, feel free to reach out.</p>
 <div class="pagination">
    
    <hr />
    Thanks for reading! This writing style focuses on clarity and simplicity, explaining concepts in accessible terms rather than pursuing strict academic precision. If you notice anything outdated, feel free to comment or send me a message. 

    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="/blog/dynamic-github-profile-with-bun-typescript/">
                <span class="button__icon">←</span>
                <span class="button__text">Dynamic Github profile with Bun and Typescript</span>
            </a>
        </span>
         
        <span class="button next">
            <a href="/blog/full-text-rss-feeds/">
                <span class="button__text">My blog now offers full-text RSS feeds</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

                    </article>
                    <div class="sharing-buttons">
    <h3>Share this post:</h3>
    <ul class="sharing-list" id="right">
        <li>
            <a
                href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform&t=Transforming%20website%20images%20into%20WebP%20with%20Rust%20for%20faster%20loading%20times"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img src="/icon/hacker-news.svg" alt="Share on Hacker News" class="sharing-icon" />
            </a>
        </li>
        <li>
            <a
                href="https://www.reddit.com/submit?url=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform&title=Transforming%20website%20images%20into%20WebP%20with%20Rust%20for%20faster%20loading%20times"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img src="/icon/reddit.svg" alt="Share on Reddit" class="sharing-icon" />
            </a>
        </li>

        <li>
            <a
                href="https://mastodon.social/share?url=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform&text=Transforming%20website%20images%20into%20WebP%20with%20Rust%20for%20faster%20loading%20times"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img src="/icon/mastodon.svg" alt="Share on Mastodon" class="sharing-icon" />
            </a>
        </li>

        <li>
            <a
                href="https://x.com/intent/tweet?url=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform&text=Transforming%20website%20images%20into%20WebP%20with%20Rust%20for%20faster%20loading%20times"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img src="/icon/x.svg" alt="Share on Twitter" class="sharing-icon" />
            </a>
        </li>

        <li>
            <a
                href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img src="/icon/facebook.svg" alt="Share on Facebook" class="sharing-icon" />
            </a>
        </li>

        <li>
            <a
                href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform&title=Transforming%20website%20images%20into%20WebP%20with%20Rust%20for%20faster%20loading%20times"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img src="/icon/linkedin.svg" alt="Share on LinkedIn" class="sharing-icon" />
            </a>
        </li>

        <li>
            <a href="mailto:?subject=Transforming%20website%20images%20into%20WebP%20with%20Rust%20for%20faster%20loading%20times&body=https%3a%2f%2ftduyng.com%2fblog%2frust-webp-transform">
                <img src="/icon/email.svg" alt="Share via Email" class="sharing-icon" />
            </a>
        </li>
    </ul>
</div>
 
<div
    class="reaction right"
    data-endpoint="https://reaction.tienduy-nguyen-dev.workers.dev"
></div>

 

                </div>

                
<script
    src="https://giscus.app/client.js"
    data-repo="tduyng/tduyng.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyNjAzNTM0NzM="
    data-category="General"
    data-category-id="DIC_kwDOD4Stwc4CfSpo"
    data-mapping="specific"
    data-term="blog/rust-webp-transform"
    data-strict="1"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="bottom"
    data-theme="dark_dimmed"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async
></script>

 <footer>
    <div class="footer-menu">
        
        <a class="instant fold" href="/tags">tags</a>
        
        <a class="instant fold" href="/subscribe">subscribe</a>
        
        <a class="instant fold" href="/contact">contact</a>
        
        <a class="instant fold" href="/privacy">privacy</a>
        
        <a class="instant fold" href="/atom.xml">rss</a>
        
    </div>
    <div class="copyright">
        ©2025 Duy NG
        <span>|</span>
        Built with
        <a href="https://github.com/tduyng/gozzi" rel="noreferrer" target="_blank">gozzi</a>
    </div>
</footer>

            </main>
        </div>
        <script src="/js/main.js" defer></script>
<script src="/js/lightense.min.js" defer></script>
 
<script
    async
    defer
    data-website-id="0403ec1f-fbf8-4e6c-b24b-0c585ca25873"
    src="https://cloud.umami.is/script.js"
    data-do-not-track="true"
></script>


    </body>
</html>
